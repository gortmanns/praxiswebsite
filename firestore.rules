rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows authenticated users to read doctor profiles and restricts write access.
     * @path /doctor_profiles/{doctorId}
     * @allow (get, list) if isSignedIn()
     * @allow (create) if false
     * @deny (update, delete) if true
     * @principle Allows public read for doctor profiles. Only admins can manage the data in this collection.
     */
    match /doctor_profiles/{doctorId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Restricts access to contact form submissions to admin users only.
     * @path /contact_form_submissions/{submissionId}
     * @allow (get, list, create, update, delete) if isAdmin()
     * @deny (get, list, create, update, delete) if !isAdmin()
     * @principle Enforces admin-only access for sensitive contact form data.
     */
    match /contact_form_submissions/{submissionId} {
      allow get, list, create, update, delete: if isAdmin();
    }

        /**
     * @description Manages admin roles. The existence of a document in this collection grants admin privileges.
     * @path /roles_admin/{userId}
     * @allow (get) if isAdmin()
     * @allow (create) if request.auth.uid == userId;
     * @deny (list) if true;
     * @allow (update, delete) if isAdmin()
     * @principle Enforces strict control over admin role assignments. Only admins can read, update and delete these role assignments, but any signed in user can assign the role to themselves to request admin access.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // --- Helper Functions ---

    /**
     * @description Checks if the user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is an admin by verifying the existence of a document in /roles_admin/{userId}.
     * @return {bool} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Checks if the requesting user is the owner of the resource.
     * @param {string} userId The user ID to compare against the request's authentication UID.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
        return request.auth.uid == userId;
    }

     /**
     * @description Checks if the requesting user is the owner of the resource and the resource exists.
     * @param {string} userId The user ID to compare against the request's authentication UID.
     * @return {bool} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && getAfter(resource) != null;
    }
  }
}