/**
 * @file Firestore Security Rules
 * @core-philosophy This ruleset enforces a role-based access control model for doctor profiles and contact form submissions.
 * Doctor profiles are publicly readable but not writable by regular users. Contact form submissions are only accessible to administrators.
 * @data-structure
 *   - `/doctor_profiles/{doctorId}`: Stores public information about doctors.
 *   - `/contact_form_submissions/{submissionId}`: Stores contact form submissions, private to admins.
 *   - `/roles_admin/{userId}`: Presence of a document grants admin privileges to the user.
 * @key-security-decisions
 *   - Doctor profiles are publicly readable, but writes are disallowed to prevent unauthorized modifications.
 *   - Contact form submissions are only accessible to admins to protect user privacy.
 *   - Listing of contact form submissions is denied to non-admin users to prevent unauthorized data access.
 * @denormalization-for-authorization To avoid complex queries, admin status is determined by the presence of a document in `/roles_admin/{userId}`.
 * This simplifies the security rules for `contact_form_submissions`.
 * @structural-segregation Publicly readable doctor profiles are stored in a separate collection from private contact form submissions.
 * This avoids the need for complex read rules based on document properties.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants read access to doctor profiles for all authenticated users, but restricts write access.
     * @path /doctor_profiles/{doctorId}
     * @allow (get, list) All authenticated users can view doctor profiles.
     * @allow (create, update, delete) No one can modify or delete doctor profiles.
     * @deny (create, update, delete) Attempts to create, update, or delete doctor profiles are denied.
     * @principle Public read access with no write access.
     */
    match /doctor_profiles/{doctorId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Restricts access to contact form submissions to administrators only.
     * @path /contact_form_submissions/{submissionId}
     * @allow (get, create, update, delete) Admins can read, create, update, and delete contact form submissions.
     * @deny (get, create, update, delete) Non-admins cannot access contact form submissions.
     * @allow list: if isAdmin();
     * @deny list: if !isAdmin();
     * @principle Role-based access control, with admin-only access.
     */
    match /contact_form_submissions/{submissionId} {
      allow get, create, update, delete: if isAdmin();
      allow list: if isAdmin();
    }

    /**
     * @description Grants admin privileges based on the existence of a document in this collection.
     * @path /roles_admin/{userId}
     * @allow create: if isOwner(userId);
     * @allow get: if isAdmin();
     * @allow list: if false;
     * @allow update: if false;
     * @allow delete: if isAdmin();
     * @principle Role-based access control, with admin-only access.
     */
    match /roles_admin/{userId} {
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow get: if isAdmin();
        allow list: if false;
        allow update: if false;
        allow delete: if isAdmin();
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
  }
}