/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces role-based access control for contact form submissions and
 * allows public read access to doctor profiles while restricting write access.
 *
 * Data Structure:
 * - /doctor_profiles/{doctorId}: Stores doctor profile information.
 * - /contact_form_submissions/{submissionId}: Stores contact form submissions.
 * - /roles_admin/{userId}: Indicates admin status; document content is irrelevant.
 *
 * Key Security Decisions:
 * - Doctor profiles are publicly readable but only admins can modify them.
 * - Contact form submissions are strictly limited to admin access only.
 * - Listing of contact form submissions is disallowed for non-admins.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants public read access to doctor profiles, but restricts write access to admins only.
     * @path /doctor_profiles/{doctorId}
     * @allow (get, list): Any authenticated user can read doctor profiles.
     * @allow (create, update, delete): Only admins can create, update, or delete doctor profiles.
     * @deny (create, update, delete): Non-admins cannot modify doctor profiles.
     * @principle Allows public read access with restricted writes.
     */
    match /doctor_profiles/{doctorId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Restricts access to contact form submissions to admins only.
     * @path /contact_form_submissions/{submissionId}
     * @allow (get): Only admins can read contact form submissions.
     * @deny (list): Listing contact form submissions is disallowed for all users.
     * @allow (create, update, delete): Only admins can create, update, or delete contact form submissions.
     * @deny (create, update, delete): Non-admins cannot modify contact form submissions.
     * @principle Enforces strict admin-only access for sensitive data.
     */
    match /contact_form_submissions/{submissionId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Grants admin privileges based on the existence of a document in this collection.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
          allow get: if isAdmin();
      allow list: if isAdmin();
          allow create: if isAdmin();
          allow update: if isAdmin();
          allow delete: if isAdmin();
        }
  }

  // Helper function to determine if a user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if a user is an admin based on the existence of their UID in `/roles_admin/{uid}`.
  function isAdmin() {
    return request.auth != null && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
  }
}