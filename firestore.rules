/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict owner-only access model for most collections,
 *              allowing only authenticated users to read and write their own data.
 *
 * Data Structure:
 * - Top-level collections: /doctors, /staff, /medicalPartners, /otherPartners, /holidays, /settings/banners
 *
 * Key Security Decisions:
 * - Public Read Access: The `doctors`, `staff`, `medicalPartners`, and `otherPartners` collections allow public read access (get, list) to facilitate displaying content without authentication.
 * - Owner-Only Writes: Writes to these collections (`create`, `update`, `delete`) are restricted to authenticated users. It is REQUIRED that each document in these collections contains an ownership field (e.g., `ownerId`, `authorId`) that matches the authenticated user's UID.
 * - Denormalization: To avoid costly `get()` calls in the rules, each document should contain all the data needed for authorization.
 * - Settings document: The document at `/settings/banners` is protected from public modification.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to the 'doctors' collection. Allows public reads and owner-only writes.
     * @path /databases/{database}/documents/doctors/{doctorId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated user with matching 'authorId' in the request.
     * @deny (create) Unauthenticated user.
     * @deny (create) Authenticated user with mismatched 'authorId'.
     * @allow (update, delete) Authenticated user who is the owner ('authorId' matches).
     * @deny (update, delete) Authenticated user who is not the owner.
     * @principle Allows public reading of doctor profiles, but restricts modifications to authorized users (owners).
     */
    match /doctors/{doctorId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(/databases/$(database)/documents/doctors/$(doctorId));
    }

    /**
     * @description Controls access to the 'staff' collection. Allows public reads and owner-only writes.
     * @path /databases/{database}/documents/staff/{staffId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated user with matching 'authorId' in the request.
     * @deny (create) Unauthenticated user.
     * @deny (create) Authenticated user with mismatched 'authorId'.
     * @allow (update, delete) Authenticated user who is the owner ('authorId' matches).
     * @deny (update, delete) Authenticated user who is not the owner.
     * @principle Allows public reading of staff profiles, but restricts modifications to authorized users (owners).
     */
    match /staff/{staffId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(/databases/$(database)/documents/staff/$(staffId));
    }

    /**
     * @description Controls access to the 'medicalPartners' collection. Allows public reads and owner-only writes.
     * @path /databases/{database}/documents/medicalPartners/{medicalPartnerId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated user with matching 'authorId' in the request.
     * @deny (create) Unauthenticated user.
     * @deny (create) Authenticated user with mismatched 'authorId'.
     * @allow (update, delete) Authenticated user who is the owner ('authorId' matches).
     * @deny (update, delete) Authenticated user who is not the owner.
     * @principle Allows public reading of medical partner information, but restricts modifications to authorized users (owners).
     */
    match /medicalPartners/{medicalPartnerId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(/databases/$(database)/documents/medicalPartners/$(medicalPartnerId));
    }

    /**
     * @description Controls access to the 'otherPartners' collection. Allows public reads and owner-only writes.
     * @path /databases/{database}/documents/otherPartners/{otherPartnerId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated user with matching 'authorId' in the request.
     * @deny (create) Unauthenticated user.
     * @deny (create) Authenticated user with mismatched 'authorId'.
     * @allow (update, delete) Authenticated user who is the owner ('authorId' matches).
     * @deny (update, delete) Authenticated user who is not the owner.
     * @principle Allows public reading of other partner information, but restricts modifications to authorized users (owners).
     */
    match /otherPartners/{otherPartnerId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(/databases/$(database)/documents/otherPartners/$(otherPartnerId));
    }

    /**
     * @description Controls access to the 'holidays' collection. Allows public reads and owner-only writes.
     * @path /databases/{database}/documents/holidays/{holidayId}
     * @allow (get, list) Public read access.
     * @allow (create) Authenticated user with matching 'authorId' in the request.
     * @deny (create) Unauthenticated user.
     * @deny (create) Authenticated user with mismatched 'authorId'.
     * @allow (update, delete) Authenticated user who is the owner ('authorId' matches).
     * @deny (update, delete) Authenticated user who is not the owner.
     * @principle Allows public reading of holiday information, but restricts modifications to authorized users (owners).
     */
    match /holidays/{holidayId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
      allow update, delete: if isSignedIn() && isExistingOwner(/databases/$(database)/documents/holidays/$(holidayId));
    }

    /**
     * @description Controls access to the 'banners' document under the 'settings' collection.
     * @path /databases/{database}/documents/settings/banners
     * @allow (get) Public read access.
     * @deny (list) Listing is not allowed on single documents.
     * @allow (create) Authenticated user with matching 'authorId' in the request.
     * @deny (create) Unauthenticated user.
     * @deny (create) Authenticated user with mismatched 'authorId'.
     * @allow (update, delete) Authenticated user who is the owner ('authorId' matches).
     * @deny (update, delete) Authenticated user who is not the owner.
     * @principle Allows public reading of banner settings, but restricts modifications to authorized users (owners).
     */
    match /settings/banners {
        allow get: if true;
        allow list: if false;
        allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
        allow update, delete: if isSignedIn() && isExistingOwner(/databases/$(database)/documents/settings/banners);
    }


    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(resourceId) {
      return request.auth.uid == get(resourceId).data.id;
    }

    function isExistingOwner(resourceId) {
        return isSignedIn() && exists(resourceId) && isOwner(resourceId);
    }
  }
}